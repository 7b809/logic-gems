//@version=5
indicator("TW All in One â€“ Long Logic + Visual Sell/SR", overlay=true, max_lines_count=100, max_labels_count=100)

// ==========================
// ðŸ”§ CONFIG
// ==========================
src           = close
maType        = input.string("EHMA", options=["HMA","EHMA","THMA"])
length        = input.int(16)
useHTF        = input.bool(false)
htf           = input.timeframe("240")

leftBars      = input.int(33)
rightBars     = input.int(21)

targetPoints  = input.int(5, "Default Target (Points)")

// ==========================
// ðŸ•’ IST TIME
// ==========================
get_ist_time(_time) =>
    ist_offset = 5 * 60 * 60 * 1000 + 30 * 60 * 1000
    str.format("{0,time,HH:mm:ss}", _time + ist_offset)

// ==========================
// ðŸ“ MA FUNCTIONS
// ==========================
HMA(_src, _len) =>
    ta.wma(2 * ta.wma(_src, math.round(_len / 2)) - ta.wma(_src, _len), math.round(math.sqrt(_len)))

EHMA(_src, _len) =>
    ta.ema(2 * ta.ema(_src, _len) - ta.ema(_src, _len), math.round(math.sqrt(_len)))

THMA(_src, _len) =>
    ta.wma(ta.wma(_src, math.round(_len / 3)) * 3 - ta.wma(_src, math.round(_len / 2)) - ta.wma(_src, _len), _len)

// ==========================
// ðŸ“Š SUPPORT & RESISTANCE (Dynamic Lines)
// ==========================
ph = ta.pivothigh(high, leftBars, rightBars)
pl = ta.pivotlow(low, leftBars, rightBars)

resistance = ta.valuewhen(ph, high[rightBars], 0)
support    = ta.valuewhen(pl, low[rightBars], 0)

// Persistent lines
var line resLine = line.new(na, na, na, na, color=color.new(color.red, 30), width=2, extend=extend.right)
var line supLine = line.new(na, na, na, na, color=color.new(color.green, 30), width=2, extend=extend.right)

// Update Resistance
if not na(resistance)
    line.set_xy1(resLine, bar_index[rightBars], resistance)
    line.set_xy2(resLine, bar_index, resistance)

// Update Support
if not na(support)
    line.set_xy1(supLine, bar_index[rightBars], support)
    line.set_xy2(supLine, bar_index, support)

// ==========================
// ðŸ“ˆ MA CALCULATION
// ==========================
ma = maType=="HMA"?HMA(src,length):maType=="EHMA"?EHMA(src,length):THMA(src,length)
finalMA = useHTF ? request.security(syminfo.tickerid, htf, ma) : ma
fastMA = finalMA
slowMA = finalMA[2]

// ==========================
// ðŸ” CROSSOVER LOGIC
// ==========================
buyCross  = ta.crossunder(slowMA, fastMA)
sellCross = ta.crossover(slowMA, fastMA)

// ==========================
// ðŸ“Š SUPPORT & RESISTANCE (Dynamic Lines)
// ==========================
ph = ta.pivothigh(high, leftBars, rightBars)
pl = ta.pivotlow(low, leftBars, rightBars)

resistance = ta.valuewhen(ph, high[rightBars], 0)
support    = ta.valuewhen(pl, low[rightBars], 0)

// These lines will now update and extend correctly
var line resLine = line.new(na, na, na, na, color=color.new(color.red, 30), width=2, extend=extend.right)
var line supLine = line.new(na, na, na, na, color=color.new(color.green, 30), width=2, extend=extend.right)

if not na(resistance)
    line.set_xy1(resLine, bar_index[rightBars], resistance)
    line.set_xy2(resLine, bar_index, resistance)
if not na(support)
    line.set_xy1(supLine, bar_index[rightBars], support)
    line.set_xy2(supLine, bar_index, support)

// ==========================
// ðŸ§  TRADE STATE (LONG TRACKING ONLY)
// ==========================
var bool  inTrade   = false
var float entryPrice = na
var float target     = na

// ==========================
// ðŸš€ SIGNALS & LABELS
// ==========================

// 1. BUY ENTRY (Starts tracking)
if buyCross
    if not inTrade
        inTrade    := true
        entryPrice := close
        target     := close + targetPoints
    
    label.new(bar_index, low, "BUY @ " + str.tostring(close) + "\n" + get_ist_time(time), style=label.style_label_up, color=color.green, textcolor=color.white)

// 2. SELL SIGNAL (Visual Only, or Long Exit)
if sellCross
    label.new(bar_index, high, "SELL @ " + str.tostring(close) + "\n" + get_ist_time(time), style=label.style_label_down, color=color.red, textcolor=color.white)
    
    // If we were in a Buy trade, close it out here
    if inTrade
        result = close > entryPrice ? "PROFIT" : "LOSS"
        label.new(bar_index, high + (high*0.001), "EXIT (" + result + ") @ " + str.tostring(close), color=close > entryPrice ? color.green : color.red, textcolor=color.white, style=label.style_label_down)
        inTrade := false

// 3. LONG TARGET HIT
if inTrade and high >= target
    label.new(bar_index, high, "ðŸŽ¯ TARGET HIT @ " + str.tostring(target) + "\n" + get_ist_time(time), color=color.blue, textcolor=color.white, style=label.style_label_down)
    inTrade := false

// ==========================
// ðŸŽ¨ PLOTS
// ==========================
plot(fastMA, color=color.blue, linewidth=2, title="Fast MA")
plot(slowMA, color=color.orange, linewidth=1, style=plot.style_stepline, title="Slow MA")