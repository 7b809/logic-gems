//@version=5
indicator("TW All in One â€“ Localized SR with Data", overlay=true, max_lines_count=100, max_labels_count=100)

// ==========================
// ðŸ”§ CONFIG
// ==========================
src           = close
maType        = input.string("EHMA", options=["HMA","EHMA","THMA"])
length        = input.int(16)
leftBars      = input.int(33, "SR Left Strength")
rightBars     = input.int(21, "SR Right Strength")
targetPoints  = input.int(5, "Default Target (Points)")

// ==========================
// ðŸ•’ IST TIME FUNCTION
// ==========================
get_ist_time(_time) =>
    ist_offset = 5 * 60 * 60 * 1000 + 30 * 60 * 1000
    str.format("{0,time,HH:mm:ss}", _time + ist_offset)

// ==========================
// ðŸ“ MA FUNCTIONS
// ==========================
HMA(_src, _len) => ta.wma(2 * ta.wma(_src, math.round(_len / 2)) - ta.wma(_src, _len), math.round(math.sqrt(_len)))
EHMA(_src, _len) => ta.ema(2 * ta.ema(_src, _len) - ta.ema(_src, _len), math.round(math.sqrt(_len)))
THMA(_src, _len) => ta.wma(ta.wma(_src, math.round(_len / 3)) * 3 - ta.wma(_src, math.round(_len / 2)) - ta.wma(_src, _len), _len)

// ==========================
// ðŸ“Š LOCALIZED S/R LOGIC
// ==========================
ph = ta.pivothigh(high, leftBars, rightBars)
pl = ta.pivotlow(low, leftBars, rightBars)

var line lastResLine = na
var line lastSupLine = na

// Resistance Logic
if not na(ph)
    if not na(lastResLine)
        line.set_x2(lastResLine, bar_index[rightBars])
        line.set_extend(lastResLine, extend.none) // Lock the old one
    
    lastResLine := line.new(bar_index[rightBars], ph, bar_index, ph, color=color.new(color.red, 20), width=2, extend=extend.right)

// Support Logic
if not na(pl)
    if not na(lastSupLine)
        line.set_x2(lastSupLine, bar_index[rightBars])
        line.set_extend(lastSupLine, extend.none) // Lock the old one
    
    lastSupLine := line.new(bar_index[rightBars], pl, bar_index, pl, color=color.new(color.green, 20), width=2, extend=extend.right)

// ==========================
// ðŸ“ˆ MA CALCULATION
// ==========================
ma = maType=="HMA"?HMA(src,length):maType=="EHMA"?EHMA(src,length):THMA(src,length)
fastMA = ma
slowMA = ma[2]

// ==========================
// ðŸ” CROSSOVER LOGIC
// ==========================
buyCross  = ta.crossunder(slowMA, fastMA)
sellCross = ta.crossover(slowMA, fastMA)

// ==========================
// ðŸ§  TRADE STATE
// ==========================
var bool   inTrade   = false
var float  entryPrice = na
var float  target     = na

// ==========================
// ðŸš€ SIGNALS & LABELS (RESTORED TIME/PRICE)
// ==========================

// 1. BUY SIGNAL
if buyCross
    if not inTrade
        inTrade    := true
        entryPrice := close
        target     := close + targetPoints
    
    label.new(bar_index, low, 
         "BUY @ " + str.tostring(close) + "\nIST: " + get_ist_time(time), 
         style=label.style_label_up, color=color.green, textcolor=color.white)

// 2. SELL SIGNAL
if sellCross
    label.new(bar_index, high, 
         "SELL @ " + str.tostring(close) + "\nIST: " + get_ist_time(time), 
         style=label.style_label_down, color=color.red, textcolor=color.white)
    
    if inTrade
        result = close > entryPrice ? "PROFIT" : "LOSS"
        label.new(bar_index, high + (high*0.002), "EXIT (" + result + ") @ " + str.tostring(close), color=close > entryPrice ? color.green : color.red, textcolor=color.white, style=label.style_label_down)
        inTrade := false

// 3. TARGET HIT
if inTrade and high >= target
    label.new(bar_index, high, "ðŸŽ¯ TARGET HIT @ " + str.tostring(target) + "\nIST: " + get_ist_time(time), color=color.blue, textcolor=color.white, style=label.style_label_down)
    inTrade := false

// ==========================
// ðŸŽ¨ PLOTS
// ==========================
plot(fastMA, color=color.blue, linewidth=2, title="Fast MA")
plot(slowMA, color=color.orange, linewidth=1, style=plot.style_stepline, title="Slow MA")