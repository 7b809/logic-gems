//@version=5
indicator("TW All in One PRO â€“ Decision & FVG", overlay=true, max_lines_count=100, max_labels_count=100)

// ==========================
// ðŸ”§ CONFIG
// ==========================
src           = close
maType        = input.string("EHMA", options=["HMA","EHMA","THMA"])
length        = input.int(16)
useHTF        = input.bool(false)
htf           = input.timeframe("240")

leftBars      = input.int(33)
rightBars     = input.int(21)

targetPoints  = input.int(5, "Default Target (Points)")

// ==========================
// ðŸ•’ IST TIME
// ==========================
get_ist_time(_time) =>
    ist_offset = 5 * 60 * 60 * 1000 + 30 * 60 * 1000
    str.format("{0,time,HH:mm:ss}", _time + ist_offset)


// ==========================
// ðŸ“ MA FUNCTIONS (Pine v5 SAFE)
// ==========================
HMA(_src, _len) =>
    ta.wma(2 * ta.wma(_src, math.round(_len / 2)) - ta.wma(_src, _len), math.round(math.sqrt(_len)))

EHMA(_src, _len) =>
    ta.ema(2 * ta.ema(_src, _len) - ta.ema(_src, _len), math.round(math.sqrt(_len)))

THMA(_src, _len) =>
    ta.wma(ta.wma(_src, math.round(_len / 3)) * 3 - ta.wma(_src, math.round(_len / 2)) - ta.wma(_src, _len), _len)




// ==========================
// ðŸ“ˆ MA
// ==========================
ma = maType=="HMA"?HMA(src,length):maType=="EHMA"?EHMA(src,length):THMA(src,length)
finalMA = useHTF ? request.security(syminfo.tickerid, htf, ma) : ma
fastMA = finalMA
slowMA = finalMA[2]

// ==========================
// ðŸ” CROSS
// ==========================
buyCross  = ta.crossunder(slowMA, fastMA)
sellCross = ta.crossover(slowMA, fastMA)

// ==========================
// ðŸ“Š SUPPORT & RESISTANCE
// ==========================
ph = ta.pivothigh(high, leftBars, rightBars)
pl = ta.pivotlow(low, leftBars, rightBars)

resistance = ta.valuewhen(ph, high[rightBars], 0)
support    = ta.valuewhen(pl, low[rightBars], 0)

line.new(bar_index[1], resistance, bar_index, resistance, color=color.red, extend=extend.right)
line.new(bar_index[1], support, bar_index, support, color=color.green, extend=extend.right)

// ==========================
// ðŸ§  TRADE STATE
// ==========================
var bool  inTrade     = false
var string tradeType = ""
var float entryPrice = na
var float target     = na

// ==========================
// ðŸš€ ENTRY
// ==========================
if buyCross and not inTrade
    inTrade := true
    tradeType := "BUY"
    entryPrice := close
    target := close + targetPoints

    label.new(bar_index, low,"BUY @ " + str.tostring(entryPrice) + " | " + get_ist_time(time),style=label.style_label_up,color=color.green,textcolor=color.white)

if sellCross and not inTrade
    inTrade := true
    tradeType := "SELL"
    entryPrice := close
    target := close - targetPoints

    label.new(bar_index, high,"SELL @ " + str.tostring(entryPrice) + " | " + get_ist_time(time),style=label.style_label_down,color=color.red,textcolor=color.white)

// ==========================
// ðŸŽ¯ TARGET HIT
// ==========================
if inTrade and tradeType=="BUY" and high >= target
    label.new(bar_index, high,"TARGET HIT @ " + str.tostring(target) + " | " + get_ist_time(time),color=color.green,textcolor=color.white)
    inTrade := false

if inTrade and tradeType=="SELL" and low <= target
    label.new(bar_index, low,"TARGET HIT @ " + str.tostring(target) + " | " + get_ist_time(time),color=color.green,textcolor=color.white)
    inTrade := false

// ==========================
// ðŸ”„ EXIT ON OPPOSITE CROSS
// ==========================
if inTrade and tradeType=="BUY" and sellCross
    result = close > entryPrice ? "PROFIT" : "LOSS"
    label.new(bar_index, high,"EXIT " + result + " @ " + str.tostring(close) + " | " + get_ist_time(time),color=close > entryPrice ? color.green : color.red,textcolor=color.white)
    inTrade := false

if inTrade and tradeType=="SELL" and buyCross
    result = close < entryPrice ? "PROFIT" : "LOSS"
    label.new(bar_index, low,"EXIT " + result + " @ " + str.tostring(close) + " | " + get_ist_time(time),color=close < entryPrice ? color.green : color.red,textcolor=color.white)
    inTrade := false

// ==========================
// ðŸŽ¨ PLOTS
// ==========================
plot(fastMA, color=color.blue, linewidth=2)
plot(slowMA, color=color.orange, linewidth=1, style=plot.style_stepline)
