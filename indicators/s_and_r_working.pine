//@version=5
indicator("temp - Support & Resistance (Auto Opposite Trade PRO)", overlay=true, max_lines_count=50, max_labels_count=500)

// ==========================
// CONFIG
// ==========================
leftBars  = input.int(33,"Left Strength")
rightBars = input.int(21,"Right Strength")

showPivotLabels      = input.bool(true,"Show Pivot Labels")
showConfirmLabels    = input.bool(true,"Show Confirm Labels")
showOppositeLabels   = input.bool(true,"Show Opposite Trade Label")

// ==========================
// IST TIME
// ==========================
get_ist_time(_time)=>str.format("{0,time,HH:mm:ss}",_time+19800000)

// ==========================
// SYMBOL
// ==========================
symbol_raw  = syminfo.tickerid
symbol_name = syminfo.ticker
chart_link  = "https://www.tradingview.com/chart/?symbol=NSE:"+symbol_name

// ==========================
// OPPOSITE STRIKE FUNCTION
// ==========================
getOpposite(_sym)=>str.contains(_sym,"C")?str.replace(_sym,"C","P"):str.contains(_sym,"P")?str.replace(_sym,"P","C"):_sym

// ==========================
// UNIVERSAL ALERT FUNCTION (ONE LINE ONLY)
// ==========================
sendEvent(_num,_type,_pivotPrice,_confirmPrice,_pivotId,_oppSym)=>alert("{\"num\":\""+_num+"\",\"type\":\""+_type+"\",\"ticker\":\""+syminfo.ticker+"\",\"symbol_raw\":\""+symbol_raw+"\",\"opposite_symbol\":\""+_oppSym+"\",\"pivot_price\":"+str.tostring(_pivotPrice)+",\"confirm_price\":"+str.tostring(_confirmPrice)+",\"pivot_id\":\""+_pivotId+"\",\"time_ist\":\""+get_ist_time(time)+"\",\"timestamp\":"+str.tostring(time)+",\"current_url\":\""+chart_link+"\",\"opposite_url\":\"https://www.tradingview.com/chart/?symbol=NSE:"+_oppSym+"\"}",alert.freq_once_per_bar_close)

// ==========================
// LABEL FUNCTIONS
// ==========================
drawPivotLabel(_x,_y,_text,_style,_bg,_txt)=>showPivotLabels?label.new(_x,_y,_text+"\nTime: "+get_ist_time(time),style=_style,color=_bg,textcolor=_txt,size=size.small):na
drawConfirmLabel(_x,_y,_text,_style,_bg,_txt)=>showConfirmLabels?label.new(_x,_y,_text+"\nTime: "+get_ist_time(time),style=_style,color=_bg,textcolor=_txt,size=size.small):na
drawOppositeLabel(_x,_y,_text,_style,_bg,_txt)=>showOppositeLabels?label.new(_x,_y,_text+"\nTime: "+get_ist_time(time),style=_style,color=_bg,textcolor=_txt,size=size.small):na

// ==========================
// PIVOTS
// ==========================
ph = ta.pivothigh(close,leftBars,rightBars)
pl = ta.pivotlow(close,leftBars,rightBars)

// ==========================
// STATE
// ==========================
var line resLine = na
var line supLine = na

// =====================================================
// ================= RESISTANCE
// =====================================================
if not na(ph)

    pivotBar = bar_index[rightBars]
    pivotId  = "R_"+str.tostring(time)
    opposite_symbol = getOpposite(symbol_name)

    // Pivot Label
    drawPivotLabel(pivotBar,ph,"R\nPrice: "+str.tostring(ph),label.style_label_down,color.red,color.white)

    // Extend Line
    if not na(resLine)
        line.set_x2(resLine,pivotBar), line.set_extend(resLine,extend.none)

    resLine := line.new(pivotBar,ph,bar_index,ph,width=2,color=color.new(color.red,20),extend=extend.right)

    // Confirm Label
    drawConfirmLabel(bar_index,close,"R CONFIRMED",label.style_label_down,color.maroon,color.white)

    if barstate.isconfirmed

        // 1️⃣ Opposite Trade Label FIRST
        drawOppositeLabel(bar_index,close,"PLACE OPPOSITE STRIKE\n"+opposite_symbol,label.style_label_down,color.orange,color.white)

        // 2️⃣ Send Alert with num = 2
        sendEvent("2","PLACE_OPPOSITE_TRADE",ph,close,pivotId,opposite_symbol)

// =====================================================
// ================= SUPPORT
// =====================================================
if not na(pl)

    pivotBar = bar_index[rightBars]
    pivotId  = "S_"+str.tostring(time)

    drawPivotLabel(pivotBar,pl,"S\nPrice: "+str.tostring(pl),label.style_label_up,color.green,color.white)

    if not na(supLine)
        line.set_x2(supLine,pivotBar), line.set_extend(supLine,extend.none)

    supLine := line.new(pivotBar,pl,bar_index,pl,width=2,color=color.new(color.green,20),extend=extend.right)

    drawConfirmLabel(bar_index,close,"S CONFIRMED",label.style_label_up,color.teal,color.white)

    if barstate.isconfirmed
        sendEvent("1","SUPPORT_CONFIRM",pl,close,pivotId,"NA")
